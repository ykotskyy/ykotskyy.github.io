<!DOCTYPE html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <title> Stock Chart in D3 </title>

<!--  <div id="chart-element" style="height: 500px"></div> -->
</head>

<body>
</body>


<style>
body {
  background: #00151c;
}
#chart {
  background: #0e3040;
  color: #67809f;
}
</style>


<script>
// All the JavaScript is here
const loadDataEndOfDay = d3.csv("data/aal_test.csv", d => ({
  date: new Date(d.Date),
  volume: Number(d.volume),
  high: Number(d.High),
  low: Number(d.Low),
  open: Number(d.Open),
  adjclose: Number(d.AdjClose),
  symbol: (d.Name)

}));

// credits: https://brendansudol.com/writing/responsive-d3
const responsivefy = svg => {
  // get container + svg aspect ratio
  const container = d3.select(svg.node().parentNode),
    width = parseInt(svg.style('width')),
    height = parseInt(svg.style('height')),
    aspect = width / height;

  // get width of container and resize svg to fit it
  const resize = () => {
    var targetWidth = parseInt(container.style('width'));
    svg.attr('width', targetWidth);
    svg.attr('height', Math.round(targetWidth / aspect));
  };

  // add viewBox and preserveAspectRatio properties,
  // and call resize so that svg resizes on inital page load
  svg
    .attr('viewBox', '0 0 ' + width + ' ' + height)
    .attr('perserveAspectRatio', 'xMinYMid')
    .call(resize);

  // to register multiple listeners for same event type,
  // you need to add namespace, i.e., 'click.foo'
  // necessary if you call invoke this function for multiple svgs
  // api docs: https://github.com/mbostock/d3/wiki/Selections#on
  d3.select(window).on('resize.' + container.attr('id'), resize);
};


loadDataEndOfDay.then(data => {
  // render the chart here
  initialiseChart(data);
});

const initialiseChart = data => {
  const margin = { top: 50, right: 50, bottom: 50, left: 50 };
  const width = window.innerWidth - margin.left - margin.right; // Use the window's width
  const height = window.innerHeight - margin.top - margin.bottom; // Use the window's height

  // add chart SVG to the page
  const svg = d3
    .select('#chart')
    .append('svg')
    .attr('width', width + margin['left'] + margin['right'])
    .attr('height', height + margin['top'] + margin['bottom'])
    .call(responsivefy)
    .append('g')
    .attr('transform', `translate(${margin['left']}, ${margin['top']})`);


  // find data range
  const xMin = d3.min(data, d => {
    return d['date'];
  });

  const xMax = d3.max(data, d => {
    return d['date'];
  });

  const yMin = d3.min(data, d => {
    return d['adjclose'];
  });

  const yMax = d3.max(data, d => {
    return d['adjclose'];
  });

  // scale using range
  const xScale = d3
    .scaleTime()
    .domain([xMin, xMax])
    .range([0, width]);

  const yScale = d3
    .scaleLinear()
    .domain([yMin - 5, yMax])
    .range([height, 0]);


  // create the axes component
  svg
    .append('g')
    .attr('id', 'xAxis')
    .attr('transform', `translate(0, ${height})`)
    .call(d3.axisBottom(xScale));

  svg
    .append('g')
    .attr('id', 'yAxis')
    .attr('transform', `translate(${width}, 0)`)
    .call(d3.axisRight(yScale));

    const line = d3
      .line()
      .x(d => {
        return xScale(d['date']);
      })
      .y(d => {
        return yScale(d['adjclose']);
      });
    // Append the path and bind data
    svg
     .append('path')
     .data([data])
     .style('fill', 'none')
     .attr('id', 'priceChart')
     .attr('stroke', 'steelblue')
     .attr('stroke-width', '1.5')
     .attr('d', line);

}



 </script>
